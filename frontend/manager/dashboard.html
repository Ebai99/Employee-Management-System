<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stellar EMS ‚Ä¢ Manager Dashboard</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="/assets/css/components.css" />
    <!-- Chart.js CDN (minimal external dependency for charts) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  </head>
  <body>
    <div class="layout">
      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="logo">
            <span class="logo-symbol">H</span>
            <div class="logo-text">
              Heritage
              <small>EMS</small>
            </div>
          </div>
          <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
        </div>

        <nav class="sidebar-nav" id="sidebarNav">
          <a
            href="#"
            class="nav-link active"
            onclick="switchSection('dashboard', event)"
          >
            <span class="icon">‚óà</span> Dashboard
          </a>
          <a href="#" class="nav-link" onclick="switchSection('team', event)">
            <span class="icon">üë•</span> My Team
          </a>
          <a href="#" class="nav-link" onclick="switchSection('tasks', event)">
            <span class="icon">‚úì</span> Tasks
          </a>
          <a href="#" class="nav-link">
            <span class="icon">üìà</span> Performance
          </a>
          <a href="#" class="nav-link">
            <span class="icon">üìä</span> Reports
          </a>
        </nav>

        <div class="sidebar-footer">
          <button class="logout-btn" onclick="logout()">
            <span class="icon">‚Ü™</span> Logout
          </button>
        </div>
      </aside>

      <!-- Main Content -->
      <div class="main-area">
        <!-- Header -->
        <header class="topbar">
          <div class="path">
            <span class="path-segment">/manager</span>
            <span class="separator"> / </span>
            <span class="current">Dashboard</span>
          </div>

          <div class="user-section">
            <div class="search-container">
              <input type="text" placeholder="Search..." class="search-input" />
              <span class="search-icon">üîç</span>
            </div>

            <button class="notification-btn" onclick="toggleNotifications()">
              <span class="bell">üîî</span>
              <span class="badge"></span>
            </button>

            <div class="user-profile">
              <div class="user-info">
                <div class="name">Jane Smith</div>
                <div class="role">Manager ‚Ä¢ Engineering</div>
              </div>
              <div class="avatar">JS</div>
            </div>
          </div>
        </header>

        <!-- Content -->
        <main class="content">
          <!-- Dashboard Section -->
          <div id="dashboardSection" style="display: block">
            <!-- KPI Cards -->
            <div class="kpi-grid">
              <div class="kpi-card cyan">
                <div class="kpi-icon">üë•</div>
                <div class="kpi-content">
                  <div class="label">Team Size</div>
                  <div class="value">12</div>
                  <div class="change positive">+2 this quarter</div>
                </div>
              </div>

              <div class="kpi-card green">
                <div class="kpi-icon">‚úì</div>
                <div class="kpi-content">
                  <div class="label">Tasks Completed</div>
                  <div class="value">156</div>
                  <div class="change positive">+23 this week</div>
                </div>
              </div>

              <div class="kpi-card amber">
                <div class="kpi-icon">‚è∞</div>
                <div class="kpi-content">
                  <div class="label">Pending Tasks</div>
                  <div class="value">34</div>
                  <div class="change warning">8 overdue</div>
                </div>
              </div>

              <div class="kpi-card green">
                <div class="kpi-icon">üìà</div>
                <div class="kpi-content">
                  <div class="label">Avg Performance</div>
                  <div class="value">87<span class="percent">%</span></div>
                  <div class="change positive">+5% vs last month</div>
                </div>
              </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
              <div class="chart-card">
                <div class="chart-header">
                  <div>
                    <h3>Team Performance</h3>
                    <p>Weekly average scores</p>
                  </div>
                  <span class="live-indicator">Live</span>
                </div>
                <div class="chart-container">
                  <canvas id="performanceChart"></canvas>
                </div>
              </div>

              <div class="chart-card">
                <div class="chart-header">
                  <h3>Task Completion</h3>
                  <p>Tasks completed per week</p>
                </div>
                <div class="chart-container">
                  <canvas id="tasksChart"></canvas>
                </div>
              </div>
            </div>

            <!-- Team & Activity -->
            <div class="bottom-grid">
              <div class="team-card">
                <div class="card-header">
                  <h3>Team Overview ‚Ä¢ Current Sprint</h3>
                  <button class="refresh-btn" onclick="loadTeamMembers()">
                    ‚Üª Refresh
                  </button>
                </div>
                <table class="team-table">
                  <thead>
                    <tr>
                      <th>Member</th>
                      <th>Role</th>
                      <th>Progress</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="teamBody"></tbody>
                </table>
              </div>

              <div class="activity-card">
                <h3>Team Attendance</h3>
                <input
                  type="date"
                  id="attendanceDate"
                  style="
                    margin-bottom: 15px;
                    padding: 8px;
                    border: 1px solid #30363d;
                    border-radius: 6px;
                    background: #0d1117;
                    color: #c9d1d9;
                  "
                />
                <div style="display: flex; gap: 10px; margin-bottom: 15px">
                  <div
                    style="
                      flex: 1;
                      text-align: center;
                      padding: 10px;
                      background: #238636;
                      border-radius: 6px;
                    "
                  >
                    <div style="font-size: 12px; color: #c9d1d9">Present</div>
                    <div
                      style="font-size: 24px; font-weight: bold"
                      id="presentCount"
                    >
                      0
                    </div>
                  </div>
                  <div
                    style="
                      flex: 1;
                      text-align: center;
                      padding: 10px;
                      background: #da3633;
                      border-radius: 6px;
                    "
                  >
                    <div style="font-size: 12px; color: #c9d1d9">Absent</div>
                    <div
                      style="font-size: 24px; font-weight: bold"
                      id="absentCount"
                    >
                      0
                    </div>
                  </div>
                  <div
                    style="
                      flex: 1;
                      text-align: center;
                      padding: 10px;
                      background: #ff9800;
                      border-radius: 6px;
                    "
                  >
                    <div style="font-size: 12px; color: #c9d1d9">On Leave</div>
                    <div
                      style="font-size: 24px; font-weight: bold"
                      id="leaveCount"
                    >
                      0
                    </div>
                  </div>
                </div>
                <div id="activityFeed" class="activity-list"></div>
              </div>
            </div>

            <!-- Team Tasks Section -->
            <div
              style="
                margin-top: 30px;
                padding: 20px;
                background: #0d1117;
                border: 1px solid #30363d;
                border-radius: 8px;
              "
            >
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 20px;
                "
              >
                <h3 style="margin: 0">Team Tasks</h3>
                <div style="display: flex; gap: 10px">
                  <button
                    class="btn btn-primary"
                    onclick="loadTeamTasks('all')"
                    style="padding: 6px 12px; font-size: 12px"
                  >
                    All
                  </button>
                  <button
                    class="btn btn-primary"
                    onclick="loadTeamTasks('pending')"
                    style="padding: 6px 12px; font-size: 12px"
                  >
                    Pending
                  </button>
                  <button
                    class="btn btn-primary"
                    onclick="loadTeamTasks('completed')"
                    style="padding: 6px 12px; font-size: 12px"
                  >
                    Completed
                  </button>
                </div>
              </div>
              <div id="teamTasksList"></div>
            </div>
          </div>

          <!-- Team Section -->
          <div id="teamSection" style="display: none">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
              "
            >
              <h2>My Team</h2>
              <button
                class="btn btn-primary"
                onclick="openModal('addTeamMemberModal')"
                style="padding: 10px 16px"
              >
                + Add Team Member
              </button>
            </div>

            <div
              style="
                background: #0d1117;
                border: 1px solid #30363d;
                border-radius: 8px;
                overflow: hidden;
              "
            >
              <table
                class="team-table"
                style="width: 100%; border-collapse: collapse"
              >
                <thead>
                  <tr
                    style="
                      background: #161b22;
                      border-bottom: 1px solid #30363d;
                    "
                  >
                    <th style="padding: 12px; text-align: left">Name</th>
                    <th style="padding: 12px; text-align: left">Email</th>
                    <th style="padding: 12px; text-align: left">Telephone</th>
                    <th style="padding: 12px; text-align: left">Status</th>
                    <th style="padding: 12px; text-align: center">Actions</th>
                  </tr>
                </thead>
                <tbody id="teamMembersBody">
                  <tr>
                    <td
                      colspan="5"
                      style="padding: 20px; text-align: center; color: #8b949e"
                    >
                      No team members yet. Add your first team member.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Tasks Section -->
          <div id="tasksSection" style="display: none">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
              "
            >
              <h2>Team Tasks</h2>
              <button
                class="btn btn-primary"
                onclick="openModal('assignTaskModal')"
                style="padding: 10px 16px"
              >
                + Assign Task
              </button>
            </div>

            <div style="margin-bottom: 15px; display: flex; gap: 10px">
              <button
                class="btn btn-primary"
                onclick="loadTeamTasks('all')"
                style="padding: 8px 12px; font-size: 12px"
              >
                All Tasks
              </button>
              <button
                class="btn btn-primary"
                onclick="loadTeamTasks('pending')"
                style="padding: 8px 12px; font-size: 12px"
              >
                Pending
              </button>
              <button
                class="btn btn-primary"
                onclick="loadTeamTasks('active')"
                style="padding: 8px 12px; font-size: 12px"
              >
                Active
              </button>
              <button
                class="btn btn-primary"
                onclick="loadTeamTasks('completed')"
                style="padding: 8px 12px; font-size: 12px"
              >
                Completed
              </button>
            </div>

            <div
              style="
                background: #0d1117;
                border: 1px solid #30363d;
                border-radius: 8px;
                overflow: hidden;
              "
            >
              <table
                class="team-table"
                style="width: 100%; border-collapse: collapse"
              >
                <thead>
                  <tr
                    style="
                      background: #161b22;
                      border-bottom: 1px solid #30363d;
                    "
                  >
                    <th style="padding: 12px; text-align: left">Task</th>
                    <th style="padding: 12px; text-align: left">Assigned To</th>
                    <th style="padding: 12px; text-align: left">Priority</th>
                    <th style="padding: 12px; text-align: left">Deadline</th>
                    <th style="padding: 12px; text-align: left">Status</th>
                    <th style="padding: 12px; text-align: center">Actions</th>
                  </tr>
                </thead>
                <tbody id="tasksTableBody">
                  <tr>
                    <td
                      colspan="6"
                      style="padding: 20px; text-align: center; color: #8b949e"
                    >
                      No tasks yet. Create your first task.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </main>

        <!-- Add Team Member Modal -->
        <div id="addTeamMemberModal" class="modal">
          <div class="modal-content" style="width: 500px">
            <div class="modal-header">
              <h2>Add Team Member</h2>
              <button
                class="close-btn"
                onclick="closeModal('addTeamMemberModal')"
              >
                &times;
              </button>
            </div>
            <form id="addTeamMemberForm" style="padding: 20px">
              <div style="margin-bottom: 15px">
                <label
                  style="display: block; margin-bottom: 5px; color: #c9d1d9"
                >
                  Select Employee
                </label>
                <select
                  id="employeeSelect"
                  name="employeeId"
                  required
                  style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #30363d;
                    border-radius: 6px;
                    background: #161b22;
                    color: #c9d1d9;
                    cursor: pointer;
                  "
                >
                  <option value="">Loading employees...</option>
                </select>
              </div>
              <div style="display: flex; gap: 10px">
                <button type="submit" class="btn btn-primary" style="flex: 1">
                  Add to Team
                </button>
                <button
                  type="button"
                  class="btn btn-secondary"
                  onclick="closeModal('addTeamMemberModal')"
                  style="flex: 1"
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Assign Task Modal -->
        <div id="assignTaskModal" class="modal">
          <div class="modal-content" style="width: 600px">
            <div class="modal-header">
              <h2>Assign Task</h2>
              <button class="close-btn" onclick="closeModal('assignTaskModal')">
                &times;
              </button>
            </div>
            <form id="assignTaskForm" style="padding: 20px">
              <div style="margin-bottom: 15px">
                <label
                  style="display: block; margin-bottom: 5px; color: #c9d1d9"
                >
                  Team Member *
                </label>
                <select
                  id="taskEmployeeSelect"
                  name="employee_id"
                  required
                  style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #30363d;
                    border-radius: 6px;
                    background: #161b22;
                    color: #c9d1d9;
                    cursor: pointer;
                  "
                >
                  <option value="">Select team member...</option>
                </select>
              </div>
              <div style="margin-bottom: 15px">
                <label
                  style="display: block; margin-bottom: 5px; color: #c9d1d9"
                >
                  Task Title *
                </label>
                <input
                  type="text"
                  id="taskTitle"
                  name="title"
                  placeholder="Enter task title"
                  required
                  style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #30363d;
                    border-radius: 6px;
                    background: #161b22;
                    color: #c9d1d9;
                    box-sizing: border-box;
                  "
                />
              </div>
              <div style="margin-bottom: 15px">
                <label
                  style="display: block; margin-bottom: 5px; color: #c9d1d9"
                >
                  Description
                </label>
                <textarea
                  id="taskDescription"
                  name="description"
                  placeholder="Enter task description"
                  rows="3"
                  style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #30363d;
                    border-radius: 6px;
                    background: #161b22;
                    color: #c9d1d9;
                    box-sizing: border-box;
                    font-family: inherit;
                  "
                ></textarea>
              </div>
              <div
                style="
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 10px;
                  margin-bottom: 15px;
                "
              >
                <div>
                  <label
                    style="display: block; margin-bottom: 5px; color: #c9d1d9"
                  >
                    Priority
                  </label>
                  <select
                    id="taskPriority"
                    name="priority"
                    style="
                      width: 100%;
                      padding: 8px;
                      border: 1px solid #30363d;
                      border-radius: 6px;
                      background: #161b22;
                      color: #c9d1d9;
                      cursor: pointer;
                    "
                  >
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                  </select>
                </div>
                <div>
                  <label
                    style="display: block; margin-bottom: 5px; color: #c9d1d9"
                  >
                    Deadline
                  </label>
                  <input
                    type="date"
                    id="taskDeadline"
                    name="deadline"
                    style="
                      width: 100%;
                      padding: 8px;
                      border: 1px solid #30363d;
                      border-radius: 6px;
                      background: #161b22;
                      color: #c9d1d9;
                      box-sizing: border-box;
                    "
                  />
                </div>
              </div>
              <div style="display: flex; gap: 10px">
                <button type="submit" class="btn btn-primary" style="flex: 1">
                  Assign Task
                </button>
                <button
                  type="button"
                  class="btn btn-secondary"
                  onclick="closeModal('assignTaskModal')"
                  style="flex: 1"
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="/assets/js/api.js"></script>
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/ui.js"></script>
    <script src="/assets/js/errorHandler.js"></script>
    <script src="/assets/js/charts.js"></script>
    <script src="script.js"></script>

    <script>
      (function () {
        try {
          const raw = localStorage.getItem("user");
          if (!raw) return;
          const user = JSON.parse(raw);
          const fullName = [user.firstname, user.lastname]
            .filter(Boolean)
            .join(" ")
            .trim();
          const initials =
            (user.firstname ? user.firstname.charAt(0) : "") +
            (user.lastname ? user.lastname.charAt(0) : "");

          const nameEl = document.querySelector(
            ".user-profile .user-info .name",
          );
          const roleEl = document.querySelector(
            ".user-profile .user-info .role",
          );
          const avatarEls = document.querySelectorAll(".user-profile .avatar");

          if (nameEl && fullName) nameEl.textContent = fullName;
          if (avatarEls && initials)
            avatarEls.forEach(
              (el) => (el.textContent = initials.toUpperCase()),
            );

          if (roleEl && user.department)
            roleEl.textContent =
              roleEl.textContent.split("‚Ä¢")[0].trim() + " ‚Ä¢ " + user.department;
        } catch (e) {
          console.error("User populate error", e);
        }
      })();
    </script>
  </body>
</html>
